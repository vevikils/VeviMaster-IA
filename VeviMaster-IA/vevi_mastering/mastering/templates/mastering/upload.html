{% extends "base.html" %}

{% block title %}Mastering Studio - VeviMaster-IA{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --glass-bg: rgba(255, 255, 255, 0.03);
        --glass-border: rgba(255, 255, 255, 0.05);
        --text-main: #ffffff;
        --text-muted: #94a3b8;
        --accent-color: #8b5cf6;
    }

    body {
        background: #0f172a;
        color: var(--text-main);
        font-family: 'Inter', system-ui, -apple-system, sans-serif;
    }

    .mastering-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem 1rem;
    }

    .studio-header {
        text-align: center;
        margin-bottom: 3rem;
    }

    .studio-title {
        font-size: 2.5rem;
        font-weight: 800;
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 0.5rem;
    }

    .studio-subtitle {
        color: var(--text-muted);
        font-size: 1.1rem;
    }

    .control-panel {
        background: var(--glass-bg);
        backdrop-filter: blur(20px);
        border: 1px solid var(--glass-border);
        border-radius: 24px;
        padding: 2rem;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    }

    /* File Upload Styling */
    .file-upload-wrapper {
        position: relative;
        margin-bottom: 3rem;
    }

    .file-upload-label {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 3rem;
        border: 2px dashed rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        background: rgba(255, 255, 255, 0.02);
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .file-upload-label:hover {
        border-color: var(--accent-color);
        background: rgba(139, 92, 246, 0.05);
    }

    .file-upload-icon {
        font-size: 3rem;
        color: var(--accent-color);
        margin-bottom: 1rem;
    }

    .file-upload-text {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    .file-upload-hint {
        color: var(--text-muted);
        font-size: 0.9rem;
    }

    input[type="file"] {
        position: absolute;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        opacity: 0;
        cursor: pointer;
    }

    /* Sliders Grid */
    .controls-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .control-group {
        background: rgba(255, 255, 255, 0.03);
        padding: 1.25rem;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .control-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .control-label {
        font-size: 0.9rem;
        font-weight: 600;
        color: #e2e8f0;
    }

    .control-value {
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.85rem;
        color: var(--accent-color);
        background: rgba(139, 92, 246, 0.1);
        padding: 2px 6px;
        border-radius: 4px;
    }

    /* Custom Range Slider */
    input[type="range"] {
        -webkit-appearance: none;
        width: 100%;
        height: 6px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 3px;
        outline: none;
    }

    input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 18px;
        height: 18px;
        background: var(--accent-color);
        border-radius: 50%;
        cursor: pointer;
        transition: transform 0.1s;
        box-shadow: 0 0 10px rgba(139, 92, 246, 0.5);
    }

    input[type="range"]::-webkit-slider-thumb:hover {
        transform: scale(1.2);
    }

    /* Preset Selection */
    .preset-section {
        margin-bottom: 3rem;
        text-align: center;
    }

    .preset-select {
        background: rgba(15, 23, 42, 0.8);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: white;
        padding: 0.75rem 2rem;
        border-radius: 12px;
        font-size: 1rem;
        cursor: pointer;
        min-width: 200px;
        outline: none;
    }

    .preset-select:focus {
        border-color: var(--accent-color);
    }

    /* Bands Section */
    .bands-container {
        margin-top: 3rem;
    }

    .bands-title {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 1.5rem;
        color: white;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .bands-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
    }

    .band-card {
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: 16px;
        padding: 1.5rem;
    }

    .band-header {
        font-weight: 700;
        color: var(--accent-color);
        margin-bottom: 1.25rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    /* Submit Button */
    .submit-btn {
        width: 100%;
        padding: 1.25rem;
        margin-top: 3rem;
        background: var(--primary-gradient);
        border: none;
        border-radius: 16px;
        color: white;
        font-size: 1.2rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 1px;
        box-shadow: 0 10px 25px -5px rgba(124, 58, 237, 0.5);
    }

    .submit-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 20px 30px -10px rgba(124, 58, 237, 0.6);
    }

    .section-divider {
        height: 1px;
        background: rgba(255, 255, 255, 0.1);
        margin: 2rem 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="mastering-container">
    <div class="studio-header">
        <h1 class="studio-title">Vevi Mastering Studio</h1>
        <p class="studio-subtitle">Inteligencia Artificial aplicada a tu música</p>
    </div>

    <form method="post" enctype="multipart/form-data" class="control-panel">
        {% csrf_token %}

        <!-- File Upload Section -->
        <div class="file-upload-wrapper">
            <label class="file-upload-label">
                <i class="fas fa-cloud-upload-alt file-upload-icon"></i>
                <span class="file-upload-text">Arrastra tu archivo aquí o haz clic para seleccionar</span>
                <span class="file-upload-hint">Soporta archivos .WAV de alta calidad</span>
                <input type="file" name="audio" accept=".wav" required onchange="updateFileName(this)">
            </label>
            <div id="file-name-display"
                style="text-align: center; color: var(--accent-color); margin-top: 1rem; font-weight: 600;"></div>
        </div>

        <!-- Preset Selection -->
        <div class="preset-section">
            <label for="preset" style="margin-right: 1rem; font-weight: 600;">Estilo de Masterización:</label>
            <select name="preset" id="preset" class="preset-select">
                <option value="normal" selected>Normal (Equilibrado)</option>
                <option value="rock">Rock / Metal</option>
                <option value="trap">Trap / Hip-Hop</option>
                <option value="drill">Drill</option>
                <option value="reggaeton">Reggaeton</option>
                <option value="rap">Rap / Boom Bap</option>
                <option value="pop">Pop Moderno</option>
                <option value="hyperpop">Hyperpop / Glitch</option>
            </select>
        </div>

        <div class="section-divider"></div>

        <!-- Global Controls -->
        <h3 class="bands-title"><i class="fas fa-sliders-h"></i> Parámetros Globales</h3>
        <div class="controls-grid">
            <div class="control-group">
                <div class="control-header">
                    <span class="control-label">Loudness Target</span>
                    <span class="control-value" id="loudness_val">-8 LUFS</span>
                </div>
                <input type="range" name="loudness" id="loudness" min="-20" max="0" step="0.1" value="-8"
                    oninput="updateSliderValue('loudness','loudness_val', ' LUFS')">
            </div>

            <div class="control-group">
                <div class="control-header">
                    <span class="control-label">Loudness Range</span>
                    <span class="control-value" id="loudness_range_val">6 LU</span>
                </div>
                <input type="range" name="loudness_range" id="loudness_range" min="0" max="20" step="0.1" value="6"
                    oninput="updateSliderValue('loudness_range','loudness_range_val', ' LU')">
            </div>

            <div class="control-group">
                <div class="control-header">
                    <span class="control-label">Ceiling (Peak)</span>
                    <span class="control-value" id="peak_val">0.98</span>
                </div>
                <input type="range" name="peak" id="peak" min="0" max="1" step="0.01" value="0.98"
                    oninput="updateSliderValue('peak','peak_val', '')">
            </div>

            <div class="control-group">
                <div class="control-header">
                    <span class="control-label">RMS Target</span>
                    <span class="control-value" id="rms_val">-10 dB</span>
                </div>
                <input type="range" name="rms" id="rms" min="-20" max="0" step="0.1" value="-10"
                    oninput="updateSliderValue('rms','rms_val', ' dB')">
            </div>

            <div class="control-group">
                <div class="control-header">
                    <span class="control-label">Dynamics</span>
                    <span class="control-value" id="dynamics_val">2.5</span>
                </div>
                <input type="range" name="dynamics" id="dynamics" min="0" max="10" step="0.1" value="2.5"
                    oninput="updateSliderValue('dynamics','dynamics_val', '')">
            </div>

            <div class="control-group">
                <div class="control-header">
                    <span class="control-label">Sharpness (Brillo)</span>
                    <span class="control-value" id="sharpness_val">2.2</span>
                </div>
                <input type="range" name="sharpness" id="sharpness" min="0" max="10" step="0.1" value="2.2"
                    oninput="updateSliderValue('sharpness','sharpness_val', '')">
            </div>

            <div class="control-group">
                <div class="control-header">
                    <span class="control-label">Space (Estéreo)</span>
                    <span class="control-value" id="space_val">-3</span>
                </div>
                <input type="range" name="space" id="space" min="-10" max="10" step="0.1" value="-3"
                    oninput="updateSliderValue('space','space_val', '')">
            </div>

            <div class="control-group">
                <div class="control-header">
                    <span class="control-label">DRR</span>
                    <span class="control-value" id="drr_val">12</span>
                </div>
                <input type="range" name="drr" id="drr" min="0" max="20" step="0.1" value="12"
                    oninput="updateSliderValue('drr','drr_val', '')">
            </div>

            <div class="control-group">
                <div class="control-header">
                    <span class="control-label">Sample Rate</span>
                    <span class="control-value" id="sample_rate_val">44100 Hz</span>
                </div>
                <input type="range" name="sample_rate" id="sample_rate" min="22050" max="192000" step="1" value="44100"
                    oninput="updateSliderValue('sample_rate','sample_rate_val', ' Hz')">
            </div>

            <div class="control-group">
                <div class="control-header">
                    <span class="control-label">Canales</span>
                    <span class="control-value" id="channels_val">2</span>
                </div>
                <input type="range" name="channels" id="channels" min="1" max="8" step="1" value="2"
                    oninput="updateSliderValue('channels','channels_val', '')">
            </div>
        </div>

        <div class="section-divider"></div>

        <!-- Frequency Bands -->
        <h3 class="bands-title"><i class="fas fa-wave-square"></i> Bandas de Frecuencia</h3>
        <div class="bands-grid">
            {% for i in "0123" %}
            <div class="band-card">
                <div class="band-header">Banda {{ forloop.counter }}</div>

                <!-- Frequencies -->
                <div class="control-group mb-3">
                    <div class="control-header">
                        <span class="control-label">Rango Frec. (Hz)</span>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="number" name="band_{{i}}_low_freq" id="low_freq_{{i}}"
                            class="form-control form-control-sm bg-dark text-white border-secondary"
                            style="width: 70px;" value="20">
                        <span class="text-muted">-</span>
                        <input type="number" name="band_{{i}}_high_freq" id="high_freq_{{i}}"
                            class="form-control form-control-sm bg-dark text-white border-secondary"
                            style="width: 70px;" value="20000">
                    </div>
                </div>

                <!-- Band Controls -->
                <div class="control-group mb-2">
                    <div class="control-header">
                        <span class="control-label">Loudness</span>
                        <span class="control-value" id="band_loudness_{{i}}_val">-18</span>
                    </div>
                    <input type="range" name="band_{{i}}_loudness" id="band_loudness_{{i}}" min="-30" max="0" step="0.1"
                        value="-18" oninput="updateSliderValue('band_loudness_{{i}}','band_loudness_{{i}}_val', '')">
                </div>

                <div class="control-group mb-2">
                    <div class="control-header">
                        <span class="control-label">Mid Mean</span>
                        <span class="control-value" id="band_mid_mean_{{i}}_val">-15</span>
                    </div>
                    <input type="range" name="band_{{i}}_mid_mean" id="band_mid_mean_{{i}}" min="-30" max="0" step="0.1"
                        value="-15" oninput="updateSliderValue('band_mid_mean_{{i}}','band_mid_mean_{{i}}_val', '')">
                </div>

                <div class="control-group mb-2">
                    <div class="control-header">
                        <span class="control-label">Side Mean</span>
                        <span class="control-value" id="band_side_mean_{{i}}_val">-20</span>
                    </div>
                    <input type="range" name="band_{{i}}_side_mean" id="band_side_mean_{{i}}" min="-30" max="0"
                        step="0.1" value="-20"
                        oninput="updateSliderValue('band_side_mean_{{i}}','band_side_mean_{{i}}_val', '')">
                </div>

                <!-- Hidden inputs for less common params to save space, but keeping them functional -->
                <input type="hidden" name="band_{{i}}_loudness_range" id="band_loudness_range_{{i}}" value="6">
                <input type="hidden" name="band_{{i}}_mid_to_side_loudness" id="band_mid_to_side_loudness_{{i}}"
                    value="-10">
                <input type="hidden" name="band_{{i}}_mid_to_side_loudness_range"
                    id="band_mid_to_side_loudness_range_{{i}}" value="10">
            </div>
            {% endfor %}
        </div>

        <button type="submit" class="submit-btn">
            <i class="fas fa-magic me-2"></i> Iniciar Masterización IA
        </button>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function updateSliderValue(sliderId, valueId, suffix) {
        document.getElementById(valueId).textContent = document.getElementById(sliderId).value + (suffix || '');
    }

    function updateFileName(input) {
        const display = document.getElementById('file-name-display');
        if (input.files && input.files[0]) {
            display.textContent = 'Archivo seleccionado: ' + input.files[0].name;
        } else {
            display.textContent = '';
        }
    }

    const PRESETS = {
        normal: {
            global: { loudness: -10, loudness_range: 8, peak: 0.95, rms: -12, dynamics: 3, sharpness: 2, space: 0, drr: 10, sample_rate: 44100, channels: 2 },
            bands: [
                { low_freq: 20, high_freq: 200, loudness: -18, mid_mean: -15, side_mean: -20 },
                { low_freq: 200, high_freq: 1000, loudness: -16, mid_mean: -13, side_mean: -18 },
                { low_freq: 1000, high_freq: 5000, loudness: -17, mid_mean: -14, side_mean: -17 },
                { low_freq: 5000, high_freq: 20000, loudness: -19, mid_mean: -16, side_mean: -16 },
            ]
        },
        rock: {
            global: { loudness: -7, loudness_range: 6, peak: 0.98, rms: -9, dynamics: 2.2, sharpness: 2.5, space: -2, drr: 12, sample_rate: 44100, channels: 2 },
            bands: [
                { low_freq: 20, high_freq: 180, loudness: -15, mid_mean: -13, side_mean: -18 },
                { low_freq: 180, high_freq: 800, loudness: -13, mid_mean: -11, side_mean: -16 },
                { low_freq: 800, high_freq: 4000, loudness: -14, mid_mean: -12, side_mean: -15 },
                { low_freq: 4000, high_freq: 20000, loudness: -17, mid_mean: -14, side_mean: -17 },
            ]
        },
        trap: {
            global: { loudness: -7, loudness_range: 4, peak: 0.99, rms: -8, dynamics: 1.8, sharpness: 2.8, space: -2, drr: 10, sample_rate: 44100, channels: 2 },
            bands: [
                { low_freq: 20, high_freq: 120, loudness: -14, mid_mean: -12, side_mean: -18 },
                { low_freq: 120, high_freq: 300, loudness: -13, mid_mean: -11, side_mean: -16 },
                { low_freq: 300, high_freq: 800, loudness: -15, mid_mean: -13, side_mean: -15 },
                { low_freq: 800, high_freq: 20000, loudness: -16, mid_mean: -14, side_mean: -14 },
            ]
        },
        drill: {
            global: { loudness: -6, loudness_range: 5, peak: 0.99, rms: -7, dynamics: 1.5, sharpness: 3, space: -1, drr: 9, sample_rate: 44100, channels: 2 },
            bands: [
                { low_freq: 20, high_freq: 100, loudness: -13, mid_mean: -11, side_mean: -17 },
                { low_freq: 100, high_freq: 400, loudness: -12, mid_mean: -10, side_mean: -15 },
                { low_freq: 400, high_freq: 2000, loudness: -14, mid_mean: -12, side_mean: -14 },
                { low_freq: 2000, high_freq: 20000, loudness: -15, mid_mean: -13, side_mean: -16 },
            ]
        },
        reggaeton: {
            global: { loudness: -8, loudness_range: 5, peak: 0.98, rms: -9, dynamics: 2, sharpness: 2.5, space: -1, drr: 11, sample_rate: 44100, channels: 2 },
            bands: [
                { low_freq: 20, high_freq: 150, loudness: -15, mid_mean: -13, side_mean: -18 },
                { low_freq: 150, high_freq: 600, loudness: -13, mid_mean: -11, side_mean: -16 },
                { low_freq: 600, high_freq: 3000, loudness: -14, mid_mean: -12, side_mean: -15 },
                { low_freq: 3000, high_freq: 20000, loudness: -17, mid_mean: -14, side_mean: -17 },
            ]
        },
        rap: {
            global: { loudness: -8, loudness_range: 7, peak: 0.97, rms: -11, dynamics: 2.7, sharpness: 2.3, space: -2, drr: 10, sample_rate: 44100, channels: 2 },
            bands: [
                { low_freq: 20, high_freq: 180, loudness: -16, mid_mean: -14, side_mean: -19 },
                { low_freq: 180, high_freq: 800, loudness: -14, mid_mean: -12, side_mean: -17 },
                { low_freq: 800, high_freq: 4000, loudness: -15, mid_mean: -13, side_mean: -16 },
                { low_freq: 4000, high_freq: 20000, loudness: -18, mid_mean: -15, side_mean: -18 },
            ]
        },
        pop: {
            global: { loudness: -8, loudness_range: 6, peak: 0.98, rms: -10, dynamics: 2.5, sharpness: 2.2, space: -3, drr: 12, sample_rate: 44100, channels: 2 },
            bands: [
                { low_freq: 20, high_freq: 150, loudness: -18, mid_mean: -15, side_mean: -25 },
                { low_freq: 150, high_freq: 400, loudness: -16, mid_mean: -13, side_mean: -20 },
                { low_freq: 400, high_freq: 800, loudness: -17, mid_mean: -14, side_mean: -18 },
                { low_freq: 800, high_freq: 20000, loudness: -18, mid_mean: -15, side_mean: -17 },
            ]
        },
        hyperpop: {
            global: { loudness: -5, loudness_range: 3, peak: 1, rms: -6, dynamics: 1.2, sharpness: 3.5, space: 2, drr: 8, sample_rate: 44100, channels: 2 },
            bands: [
                { low_freq: 20, high_freq: 200, loudness: -12, mid_mean: -10, side_mean: -14 },
                { low_freq: 200, high_freq: 1000, loudness: -10, mid_mean: -8, side_mean: -12 },
                { low_freq: 1000, high_freq: 5000, loudness: -11, mid_mean: -9, side_mean: -11 },
                { low_freq: 5000, high_freq: 20000, loudness: -13, mid_mean: -11, side_mean: -13 },
            ]
        },
    };

    function setPreset(preset) {
        if (!PRESETS[preset]) return;
        const g = PRESETS[preset].global;

        // Update global sliders
        const globalParams = ['loudness', 'loudness_range', 'peak', 'rms', 'dynamics', 'sharpness', 'space', 'drr', 'sample_rate', 'channels'];
        const suffixes = { 'loudness': ' LUFS', 'loudness_range': ' LU', 'rms': ' dB', 'sample_rate': ' Hz' };

        globalParams.forEach(param => {
            const el = document.getElementById(param);
            if (el) {
                el.value = g[param];
                updateSliderValue(param, param + '_val', suffixes[param] || '');
            }
        });

        // Update bands
        const bands = PRESETS[preset].bands;
        for (let i = 0; i < 4; i++) {
            const b = bands[i];
            if (document.getElementById(`low_freq_${i}`)) document.getElementById(`low_freq_${i}`).value = b.low_freq;
            if (document.getElementById(`high_freq_${i}`)) document.getElementById(`high_freq_${i}`).value = b.high_freq;

            if (document.getElementById(`band_loudness_${i}`)) {
                document.getElementById(`band_loudness_${i}`).value = b.loudness;
                updateSliderValue(`band_loudness_${i}`, `band_loudness_${i}_val`, '');
            }
            if (document.getElementById(`band_mid_mean_${i}`)) {
                document.getElementById(`band_mid_mean_${i}`).value = b.mid_mean;
                updateSliderValue(`band_mid_mean_${i}`, `band_mid_mean_${i}_val`, '');
            }
            if (document.getElementById(`band_side_mean_${i}`)) {
                document.getElementById(`band_side_mean_${i}`).value = b.side_mean;
                updateSliderValue(`band_side_mean_${i}`, `band_side_mean_${i}_val`, '');
            }
        }
    }

    document.getElementById('preset').addEventListener('change', function () {
        setPreset(this.value);
    });

    // Initialize
    window.onload = function () {
        setPreset(document.getElementById('preset').value);
    };
</script>
{% endblock %}